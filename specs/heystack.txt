<project_specification>
  <project_name>Heystack - File Analysis Platform</project_name>

  <overview>
    A sophisticated file analysis and monitoring web application that provides intelligent file system monitoring, content analysis, and rich visual insights. The application continuously monitors configured file system paths with recursive traversal, detects file changes, performs advanced content analysis, and provides powerful search and visualization capabilities. Built on the Spernakit stack with JSON-driven configuration, it serves system administrators, content managers, and data analysts who need deep visibility into large file systems.
  </overview>

  <technology_stack>
    <api_key>
      You can use an API key located at /tmp/api-key for testing. You will not be allowed to read this file, but you can reference it in code.
    </api_key>
    <frontend>
      <framework>React 19 with Vite 5</framework>
      <styling>Tailwind CSS with DaisyUI component library</styling>
      <state_management>TanStack Query for server state, React Context for app state</state_management>
      <routing>React Router with ProtectedRoute components</routing>
      <markdown>React Markdown for message rendering</markdown>
      <code_highlighting>Syntax highlighting with Monaco-compatible themes</code_highlighting>
      <visualization>D3.js v7 for advanced data visualization</visualization>
      <port>Only launch on port {frontend_port}</port>
    </frontend>
    <backend>
      <runtime>Node.js with Express 5, running on Bun</runtime>
      <database>SQLite with Prisma ORM (PostgreSQL-compatible schema)</database>
      <api_integration>Claude API via Anthropic SDK for file/content analysis</api_integration>
      <streaming>Server-Sent Events for streaming responses, WebSocket for notifications</streaming>
      <file_scanner>Node worker with optional PowerShell child-process bridge</file_scanner>
      <scheduler>Cron-expression and calendar-based scheduling engine</scheduler>
    </backend>
    <communication>
      <api>RESTful endpoints with RBAC protection</api>
      <streaming>SSE for streaming assistant responses, WebSocket for real-time updates</streaming>
      <claude_api>Integration with Claude API using Anthropic SDK</claude_api>
      <authentication>JWT with HTTP-only cookies and 5-tier RBAC system</authentication>
    </communication>
  </technology_stack>

  <prerequisites>
    <environment_setup>
      - Application configuration stored in config/heystack.json
      - Frontend dependencies installed via bun install in /frontend
      - Backend dependencies installed via bun install in /backend
      - Database bootstrapped via bun run db:setup
      - Development assumes Bun environment with no implicit .env loading
    </environment_setup>
  </prerequisites>

  <core_features>
    <assistant_panel>
      - Clean, centered chat layout with message bubbles for file analysis
      - Streaming responses with typing indicators and partial rendering
      - Markdown rendering with lists, headers, tables, and inline images
      - Code blocks with syntax highlighting, language labels, and copy button
      - LaTeX/math equation rendering for technical content
      - Image upload and inline preview with audit trail
      - Multi-turn conversational context with correct model parameters
      - Message editing and regeneration with history tracking
      - Stop-generation button during streaming
      - Auto-resizing textarea with character count and token estimation
      - Keyboard shortcuts (Enter to send, Shift+Enter for newline)
    </assistant_panel>

    <artifacts>
      - Automatic detection of artifact-style responses (code, diagrams, docs)
      - Side-panel artifact viewer with tabbed layout
      - Code artifact viewer with diffing between versions
      - HTML/SVG live preview with safe rendering
      - React component preview where safe and practical
      - Mermaid diagram rendering with interactive elements
      - Text document artifact support with full-screen mode
      - Artifact editing and re-prompting based on current version
      - Download/copy artifact content with version history
      - Artifact versioning and audit log entries
    </artifacts>

    <investigation_management>
      - Create, rename, duplicate, and delete (soft-delete) investigation sessions
      - Sidebar list with virtual scrolling for large histories
      - Automatic title generation from first exchange with inline rename
      - Investigation search by title/content and related file context
      - Pin and archive investigation sessions with folder organization
      - Project-based organization with knowledge base documents
      - Export investigation history to JSON, Markdown, and PDF
      - Timestamps (created, updated, last accessed) with activity markers
      - Full audit trail of all investigation-level actions
    </investigation_management>

    <projects>
      - Create projects to group monitored paths and scan configurations
      - Upload project knowledge base documents with metadata
      - Project-specific custom instructions and default settings
      - RBAC-based project sharing with team collaboration features
      - Project analytics including usage, scan coverage, and key tags
      - Project templates for common use cases and workflows
    </projects>

    <model_selection>
      - Model selector with Claude Sonnet 4.5 (default), Haiku 4.5, Opus 4.1
      - Context window and capability indicators per model
      - Model pricing information display (no billing integration)
      - Ability to switch models mid-conversation with clear UX
      - Optional model comparison and help view
    </model_selection>

    <custom_instructions>
      - Global custom instructions per user with inheritance
      - Project-specific instructions layered on global settings
      - Conversation-specific system prompts layered on project/global
      - Instruction templates and presets with quick access
      - Preview area explaining how instructions influence responses
    </custom_instructions>

    <file_monitoring>
      - Configurable root paths and include/exclude patterns
      - Recursive directory traversal with metadata capture
      - Change detection (new/modified/deleted files) with snapshots
      - File type identification by extension and magic bytes
      - File metadata extraction (size, timestamps, permissions)
      - Binary-safe scanning and text extraction
      - Efficient handling of 1M+ files with indexing and pagination
      - Real-time change notifications via WebSocket
    </file_monitoring>

    <content_analysis>
      - Text extraction across common document formats
      - Summarization and key-phrase extraction via Claude
      - Categorization with confidence scores and auto-tagging
      - Automatic tag generation based on content and context
      - Duplicate and near-duplicate detection with similarity scoring
      - Relationship mapping between files, tags, and conversations
    </content_analysis>

    <scheduling>
      - Cron-like and calendar-style scheduling for scans and automations
      - Support for presets (hourly, daily, weekly, monthly) and custom cron
      - Timezone-aware scheduling with DST-safe logic
      - Pause/resume/cancel operations with audit logs
      - Resource throttling controls (concurrency, IO caps)
      - Retry with exponential backoff and capped attempts
      - History view of schedule runs with metrics and outcomes
    </scheduling>

    <visualization_dashboard>
      - D3-based dashboards for scan coverage, tag distributions, trends
      - Relationship graphs linking files, tags, and conversations
      - Zoom/pan/hover interactions with 60fps performance target
      - Export visuals to PNG/SVG/PDF formats
      - Configurable layouts with panels and saved views
    </visualization_dashboard>

    <admin_audit_security>
      - RBAC-aware admin views for user and role management
      - System metrics dashboard and audit log browsing
      - Comprehensive audit logging for all sensitive actions
      - Soft-delete patterns for key entities with recovery options
    </admin_audit_security>
  </core_features>

  <database_schema>
    <tables>
      <users>
        - id, username, email, passwordHash, role
        - resetToken, resetTokenExpiry, isDeleted, deletedAt, deletedBy
        - createdAt, updatedAt, failedLoginAttempts, lockedUntil
        - passwordChangedAt, lastLoginAt
      </users>

      <projects>
        - id, userId, name, description, color
        - customInstructions, knowledgeBasePath
        - createdAt, updatedAt, isArchived, isPinned
      </projects>

      <investigations>
        - id, userId, projectId, title, model
        - createdAt, updatedAt, lastMessageAt, isArchived
        - isPinned, isDeleted, settings (JSON)
        - messageCount, tokenCount
      </investigations>

      <messages>
        - id, investigationId, role (user/assistant/system)
        - content, createdAt, editedAt, tokens
        - images (JSON array), parentMessageId
      </messages>

      <artifacts>
        - id, messageId, investigationId, type
        - title, identifier, language, content
        - version, createdAt, updatedAt
      </artifacts>

      <files>
        - id, projectId, scanId, path, filename
        - extension, size, checksum, mimeType
        - isText, createdAt, updatedAt, lastScannedAt
      </files>

      <file_contents>
        - id, fileId, extractedText, summary
        - categories (JSON), tags (JSON)
        - createdAt, updatedAt
      </file_contents>

      <scans>
        - id, projectId, name, rootPath, patterns
        - status, createdAt, startedAt, completedAt
        - filesScanned, filesAdded, filesModified, filesDeleted
      </scans>

      <schedules>
        - id, projectId, name, cronExpression
        - timezone, isActive, resourceLimits
        - createdAt, updatedAt, lastRunAt, nextRunAt
      </projects>

      <audit_logs>
        - id, userId, action, resource, resourceId
        - details (JSON), ipAddress, createdAt
      </audit_logs>
    </tables>
  </database_schema>

  <api_endpoints_summary>
    <authentication>
      - POST /api/auth/login
      - POST /api/auth/logout
      - POST /api/auth/register
      - POST /api/auth/refresh
      - GET /api/auth/me
    </authentication>

    <investigations>
      - GET /api/investigations
      - POST /api/investigations
      - GET /api/investigations/:id
      - PUT /api/investigations/:id
      - DELETE /api/investigations/:id
      - POST /api/investigations/:id/duplicate
      - POST /api/investigations/:id/export
    </investigations>

    <messages>
      - GET /api/investigations/:id/messages
      - POST /api/investigations/:id/messages
      - PUT /api/messages/:id
      - DELETE /api/messages/:id
      - POST /api/messages/:id/regenerate
      - GET /api/messages/stream (SSE endpoint)
    </messages>

    <artifacts>
      - GET /api/investigations/:id/artifacts
      - GET /api/artifacts/:id
      - PUT /api/artifacts/:id
      - DELETE /api/artifacts/:id
      - POST /api/artifacts/:id/fork
    </artifacts>

    <projects>
      - GET /api/projects
      - POST /api/projects
      - GET /api/projects/:id
      - PUT /api/projects/:id
      - DELETE /api/projects/:id
      - POST /api/projects/:id/knowledge
      - PUT /api/projects/:id/settings
    </projects>

    <files>
      - GET /api/files
      - GET /api/files/:id
      - GET /api/files/:id/content
      - POST /api/files/search
      - GET /api/files/relationships/:id
    </files>

    <scans>
      - GET /api/scans
      - POST /api/scans
      - GET /api/scans/:id
      - POST /api/scans/:id/start
      - POST /api/scans/:id/stop
      - GET /api/scans/:id/progress
    </scans>

    <schedules>
      - GET /api/schedules
      - POST /api/schedules
      - PUT /api/schedules/:id
      - DELETE /api/schedules/:id
      - POST /api/schedules/:id/run
      - PUT /api/schedules/:id/toggle
    </schedules>

    <claude_api>
      - POST /api/claude/chat (proxy to Claude API)
      - POST /api/claude/chat/stream (streaming proxy)
      - GET /api/claude/models
    </claude_api>
  </api_endpoints_summary>

  <ui_layout>
    <main_structure>
      - Three-column layout: sidebar (investigations), main (chat), panel (artifacts)
      - Collapsible sidebar with resize handle
      - Responsive breakpoints: mobile (single column), tablet (two column), desktop (three column)
      - Persistent header with project/model selector
      - Bottom input area with send button and options
    </main_structure>

    <sidebar_left>
      - New investigation button (prominent)
      - Project selector dropdown
      - Search investigations input
      - Investigation list (grouped by date: Today, Yesterday, Previous 7 days, etc.)
      - Folder tree view (collapsible)
      - Settings gear icon at bottom
      - User profile at bottom
    </sidebar_left>

    <main_chat_area>
      - Investigation title (editable inline)
      - Model selector badge
      - Message history (scrollable)
      - Welcome screen for new investigations
      - Suggested prompts (empty state)
      - Input area with formatting toolbar
      - Attachment button for images
      - Send button with loading state
      - Stop generation button
    </main_chat_area>

    <artifacts_panel>
      - Artifact header with title and type badge
      - Code editor or preview pane
      - Tabs for multiple artifacts
      - Full-screen toggle
      - Download button
      - Edit/Re-prompt button
      - Version selector
      - Close panel button
    </artifacts_panel>

    <modals_overlays>
      - Settings modal (tabbed interface)
      - Share investigation modal
      - Export options modal
      - Project settings modal
      - Scan configuration modal
      - Schedule editor modal
      - Command palette overlay
      - Keyboard shortcuts reference
    </modals_overlays>
  </ui_layout>

  <design_system>
    <color_palette>
      - Primary: Orange/amber accent (#CC785C claude-style)
      - Background: White (light mode), Dark gray (#1A1A1A dark mode)
      - Surface: Light gray (#F5F5F5 light), Darker gray (#2A2A2A dark)
      - Text: Near black (#1A1A1A light), Off-white (#E5E5E5 dark)
      - Borders: Light gray (#E5E5E5 light), Dark gray (#404040 dark)
      - Code blocks: Monaco editor theme
    </color_palette>

    <typography>
      - Sans-serif system font stack (Inter, SF Pro, Roboto, system-ui)
      - Headings: font-semibold
      - Body: font-normal, leading-relaxed
      - Code: Monospace (JetBrains Mono, Consolas, Monaco)
      - Message text: text-base (16px), comfortable line-height
    </typography>

    <components>
      <message_bubble>
        - User messages: Right-aligned, subtle background
        - Assistant messages: Left-aligned, no background
        - Markdown formatting with proper spacing
        - Inline code with bg-gray-100 background
        - Code blocks with syntax highlighting
      </message_bubble>

      <buttons>
        - Primary: Orange/amber background, white text, rounded
        - Secondary: Border style with hover fill
        - Icon buttons: Square with hover background
        - Disabled state: Reduced opacity, no pointer events
      </buttons>

      <inputs>
        - Rounded borders with focus ring
        - Textarea auto-resize
        - Placeholder text in gray
        - Error states in red
        - Character counter
      </inputs>

      <cards>
        - Subtle border or shadow
        - Rounded corners (8px)
        - Padding: p-4 to p-6
        - Hover state: slight shadow increase
      </cards>
    </components>

    <animations>
      - Smooth transitions (150-300ms)
      - Fade in for new messages
      - Slide in for sidebar
      - Typing indicator animation
      - Loading spinner for generation
      - Skeleton loaders for content
    </animations>
  </design_system>

  <key_interactions>
    <investigation_flow>
      1. User selects or creates a project (optional but recommended)
      2. User starts new investigation or resumes existing one
      3. User configures model and key parameters as needed
      4. User types prompt about files/analysis and sends
      5. Backend streams assistant responses via SSE, UI renders progressively
      6. Any detected artifacts appear in side panel with preview
      7. User may edit messages, regenerate responses, or branch investigation
      8. All actions logged for auditing
    </investigation_flow>

    <file_scan_flow>
      1. Admin configures root paths and filters
      2. User defines one-off scan or schedule using scheduler UI
      3. Scan queued and executed by scanner service with progress updates
      4. UI displays progress (files processed, estimated time, anomalies)
      5. Results feed into dashboards and search capabilities
      6. Subsequent scans reuse checksums for efficiency
    </file_scan_flow>

    <artifact_flow>
      1. Claude response contains code block or structured content
      2. Application detects artifact and surfaces in side panel
      3. User opens artifact, views, and optionally edits
      4. User can re-prompt Claude using artifact as context
      5. User may download, copy, or full-screen artifact
      6. Version history and audit events recorded
    </artifact_flow>
  </key_interactions>

  <implementation_steps>
    <step number="1">
      <title>Project Foundation and Database</title>
      <tasks>
        - Initialize monorepo with Bun and Spernakit template
        - Set up /frontend and /backend workspaces
        - Configure bunfig.toml and workspace scripts
        - Configure ESLint, Prettier, and TypeScript strict mode
        - Create config/heystack.json and environment variants
        - Initialize Prisma with SQLite database and base schema
        - Seed default RBAC roles and test users
      </tasks>
    </step>

    <step number="2">
      <title>Authentication, RBAC, and Security</title>
      <tasks>
        - Implement JWT-based auth with HTTP-only cookies
        - Implement 5-tier RBAC system with inheritance
        - Add ProtectedRoute components and RBAC-aware menus
        - Implement authorize() middleware in backend
        - Set up baseline audit logging service
        - Configure CORS, CSP, rate limiting, and validation
      </tasks>
    </step>

    <step number="3">
      <title>Core Database Schema</title>
      <tasks>
        - Model users, roles, projects, investigations, messages, artifacts
        - Model file entities, tags, relationships, scan metadata
        - Model schedules, jobs, and job runs for scheduler
        - Add audit fields and soft-delete patterns
        - Add strategic indexes for common queries
        - Generate migrations and run via Bun scripts
      </tasks>
    </step>

    <step number="4">
      <title>Assistant Panel and Analysis Integration</title>
      <tasks>
        - Build assistant panel layout with sidebar + main panel
        - Implement SSE-based streaming response handling
        - Integrate Anthropic SDK behind backend proxy routes
        - Add markdown + code block rendering on frontend
        - Implement stop-generation, regenerate, and edit flows
        - Add model selection and advanced settings UI
      </tasks>
    </step>

    <step number="5">
      <title>Investigation Sessions and Projects</title>
      <tasks>
        - Implement CRUD for investigations and folders/projects
        - Add sidebar with virtual scrolling and search
        - Implement pin, archive, and soft-delete
        - Implement project selector and project-scoped views
        - Add export functionality (JSON, Markdown, PDF)
      </tasks>
    </step>

    <step number="6">
      <title>Artifacts System</title>
      <tasks>
        - Detect artifact-worthy content in Claude responses
        - Implement artifact panel with tabs and previews
        - Add versioning and editing flows
        - Integrate code viewer and Mermaid renderer
        - Hook artifact actions into audit logging
      </tasks>
    </step>

    <step number="7">
      <title>File Scanner and Content Analysis</title>
      <tasks>
        - Implement scanner service and filesystem adapters
        - Integrate optional PowerShell bridge for Windows
        - Model scans, scan runs, and file metadata in Prisma
        - Implement content extraction and analysis pipeline
        - Store summaries, tags, relationships, checksums
        - Ensure scanner performance and resilience
      </tasks>
    </step>

    <step number="8">
      <title>Scheduler and Automation</title>
      <tasks>
        - Implement scheduler engine with cron and calendar rules
        - Persist schedule definitions and runs
        - Expose scheduler APIs and admin UI
        - Wire scheduler to scanner and automations
        - Add pause/resume/cancel and resource throttling
      </tasks>
    </step>

    <step number="9">
      <title>Dashboards and Visualizations</title>
      <tasks>
        - Build D3-based dashboards for key metrics
        - Implement relationship graphs with zoom/pan/hover
        - Add export of charts/graphs
        - Optimize visualizations for performance
      </tasks>
    </step>

    <step number="10">
      <title>Security, Observability, and Admin UX</title>
      <tasks>
        - Finalize audit logging and admin dashboards
        - Implement health, readiness, and liveness endpoints
        - Expose metrics endpoint for Prometheus
        - Add admin-only views for logs, metrics, scans
        - Harden error handling and user-facing messages
      </tasks>
    </step>

    <step number="11">
      <title>Polish, Testing, and Deployment</title>
      <tasks>
        - Implement full testing strategy (unit, integration, E2E, performance)
        - Polish UI for accessibility (WCAG 2.1 AA) and responsiveness
        - Optimize bundle sizes and load times
        - Build Docker image with nginx + supervisord
        - Configure production deployment, backups, monitoring
      </tasks>
    </step>
  </implementation_steps>

  <success_criteria>
    <functionality>
      - Smooth SSE streaming for assistant responses with responsive UI
      - Accurate artifact detection and rendering
      - Reliable conversation/project management with soft delete
      - Correct RBAC enforcement across all features
      - File scanning and analysis functioning at target scale (1M+ files)
      - Scheduling system reliably executing jobs with retries
      - Dashboards and visualizations updating based on live data
    </functionality>

    <user_experience>
      - UI uses familiar assistant-style layout while emphasizing file analysis workflows
      - Responsive layout across desktop, tablet, and mobile
      - Clear feedback for all user actions (loading, errors, confirmations)
      - Fast perceived performance, minimal visible blocking
      - Keyboard-accessible navigation and controls
    </user_experience>

    <technical_quality>
      - TypeScript strict mode passes with no errors
      - Lint and format checks pass with no violations
      - bun run build succeeds without warnings
      - Database schema and queries validated under load
      - Error handling and logging present at critical paths
    </technical_quality>

    <design_polish>
      - Consistent typography, spacing, and component usage
      - Fully functional dark mode with DaisyUI themes
      - Smooth micro-interactions and transitions
      - Accessible color contrast and focus states
    </design_polish>

    <security_compliance>
      - RBAC hierarchy enforced on backend and reflected in UI
      - All sensitive actions logged with sufficient context
      - Input validation and sanitization for external inputs
      - Rate limiting active on sensitive routes
      - Authentication with HTTP-only cookies and secure defaults
      - Soft delete patterns applied where required
    </security_compliance>

    <performance_benchmarks>
      - API: 95% requests <= 500ms; p99 within SLO
      - DB: 95% complex queries <= 100ms
      - UI: initial page usable in <= 200ms on modern hardware
      - Search: results for 1M files <= 500ms (p95)
      - Concurrent users: stable for 50+ concurrent sessions
      - Charts: render in <= 200ms for 10,000 items
      - Graphs: layouts complete in <= 1s for ~1,000 nodes
    </performance_benchmarks>
  </success_criteria>
</project_specification>
